{% extends "base.html" %}

{% block title %}Select Items - {{ group.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="form-container">
        <div class="form-header">
            <h2>üçΩÔ∏è Select Your Items</h2>
            <p>From <strong>{{ receipt_analysis['store_name'] or "Receipt" }}</strong> ‚Ä¢ Total: ‚Ç¨{{ "%.2f"|format(receipt_analysis['total_amount']) }}</p>
        </div>
        
        <form method="POST" id="itemSelectionForm">
            <input type="hidden" id="confirmedPayments" name="confirmed_payments" value="">
            <input type="hidden" id="guestUsers" name="guest_users" value="">
            <div class="receipt-items-container">
                <div class="receipt-summary">
                    <h3>üìã Receipt Items</h3>
                    <p>Select which group members consumed each item. Items can be shared between multiple people.</p>
                </div>
                
                <div class="payer-selection">
                    <h4>üí≥ Who paid this bill?</h4>
                    <select name="bill_payer" id="billPayer" class="user-dropdown" required>
                        <option value="">Select who paid the bill...</option>
                        {% for member in members %}
                            <option value="{{ member['id'] }}" {% if member['id'] == current_user.id %}selected{% endif %}>
                                {{ member['username'] }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Guest Users Section -->
                <div class="guest-users-section">
                    <div class="guest-header">
                        <h4>üë• Add Guest Users</h4>
                        <p class="guest-description">Add temporary guests for this receipt only</p>
                        <button type="button" class="btn btn-small btn-secondary" onclick="addGuestUser()">+ Add Guest</button>
                    </div>
                    <div class="guest-users-list" id="guestUsersList">
                        <!-- Guest users will be added here dynamically -->
                    </div>
                </div>
                
                <div class="items-list">
                    {% for item in receipt_analysis['items'] %}
                        <div class="item-card">
                            <div class="item-info">
                                <div class="item-name">{{ item.name }}</div>
                                <div class="item-price">‚Ç¨{{ "%.2f"|format(item.price) }}</div>
                            </div>
                            
                            <div class="item-selection">
                                <div class="selection-row">
                                    <div class="selection-main">
                                        <select name="item_{{ loop.index0 }}_user" class="user-dropdown">
                                            <option value="">Select who had this item...</option>
                                            {% for member in members %}
                                                <option value="{{ member['id'] }}">{{ member['username'] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="split-option">
                                        <label class="split-checkbox">
                                            <input type="checkbox" 
                                                   name="item_{{ loop.index0 }}_split" 
                                                   data-item-index="{{ loop.index0 }}">
                                            <span class="checkbox-custom"></span>
                                            Split
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="split-members" id="split-members-{{ loop.index0 }}" style="display: none;">
                                    <div class="split-checkboxes">
                                        {% for member in members %}
                                            <label class="member-checkbox">
                                                <input type="checkbox" 
                                                       name="item_{{ loop.index0 }}_user_{{ member['id'] }}" 
                                                       id="item_{{ loop.index0 }}_user_{{ member['id'] }}" 
                                                       value="{{ member['id'] }}">
                                                <span class="checkbox-custom"></span>
                                                <span class="member-name">{{ member['username'] }}</span>
                                            </label>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <div class="item-split-info" id="item-{{ loop.index0 }}-split">
                                    <span class="split-text">Select who had this item</span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="selection-summary" id="selectionSummary">
                    <h3>üí∞ Your Total</h3>
                    <div class="summary-content">
                        <p>Select items to see your total amount</p>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                        <span class="btn-icon">‚úÖ</span>
                        Add Selected Items
                    </button>
                    <a href="{{ url_for('scan_receipt', group_id=group.id) }}" class="btn btn-secondary">
                        Back to Upload
                    </a>
                    <a href="{{ url_for('add_expense', group_id=group.id) }}" class="btn btn-secondary">
                        Manual Entry Instead
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal" id="qrModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üí≥ Payment QR Code</h3>
            <button class="modal-close" onclick="closeQRModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="qrContent">
                <div class="qr-loading">
                    <div class="loading-spinner">‚è≥</div>
                    <p>Generating QR code...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="application/json" id="receipt-items-data">{{ receipt_analysis['items']|tojson }}</script>
<script type="application/json" id="members-data">{{ members|tojson }}</script>
<script>
let receiptItems = [];
let members = [];
let guestUsers = [];
let guestIdCounter = 1000; // Start with high number to avoid conflicts with member IDs

document.addEventListener('DOMContentLoaded', function() {
    receiptItems = JSON.parse(document.getElementById('receipt-items-data').textContent);
    members = JSON.parse(document.getElementById('members-data').textContent);
    
    console.log('=== Receipt Items Page Initialized ===');
    console.log('Receipt items:', receiptItems.length);
    console.log('Members:', members.length);
    
    // Debug all checkboxes on page load
    const allUserCheckboxes = document.querySelectorAll('input[name*="_users"]');
    const allSplitCheckboxes = document.querySelectorAll('input[name*="_split"]');
    console.log(`Found ${allUserCheckboxes.length} user checkboxes and ${allSplitCheckboxes.length} split checkboxes`);
    
    allUserCheckboxes.forEach((cb, i) => {
        const styles = window.getComputedStyle(cb);
        console.log(`User checkbox ${i}: opacity=${styles.opacity}, visible=${styles.visibility}, display=${styles.display}`);
    });
    
    // Add event listeners to all split checkboxes for real-time updates
    document.querySelectorAll('input[name*="_users"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            try {
                const itemIndex = this.name.match(/item_(\d+)_users/)[1];
                const userName = members.find(m => m.id == this.value)?.username || 'Unknown';
                console.log(`üîÑ User checkbox clicked: ${this.name} = ${this.checked} (${userName} for item ${itemIndex})`);
                
                // Count checked boxes for this item immediately
                const checkedForThisItem = document.querySelectorAll(`input[name="item_${itemIndex}_users"]:checked`).length;
                console.log(`   Now ${checkedForThisItem} people selected for item ${itemIndex}`);
                
                updateItemSummary();
            } catch (error) {
                console.error('Error in user checkbox change handler:', error);
            }
        });
    });
    
    // Add event listeners to split mode checkboxes
    document.querySelectorAll('input[name*="_split"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            try {
                const itemIndex = this.dataset.itemIndex || this.name.match(/item_(\d+)_split/)[1];
                console.log(`üîÑ Split mode checkbox clicked: ${this.name} = ${this.checked} for item ${itemIndex}`);
                
                // Call the toggle function AND update summary
                toggleSplitMode(parseInt(itemIndex));
                updateItemSummary();
            } catch (error) {
                console.error('Error in split checkbox change handler:', error);
            }
        });
    });
    
    // Add event listeners to all user dropdowns for real-time updates
    document.querySelectorAll('select[name*="_user"]').forEach(dropdown => {
        dropdown.addEventListener('change', function() {
            updateItemSummary();
        });
    });
    
    // Add event listener to bill payer dropdown
    const billPayerDropdown = document.getElementById('billPayer');
    if (billPayerDropdown) {
        billPayerDropdown.addEventListener('change', function() {
            updateItemSummary();
        });
    }
    
    updateItemSummary();
    
    // Debug function for testing calculation manually
    window.testSplitCalculation = function(itemPrice, numberOfPeople) {
        const splitAmount = Math.round((itemPrice / numberOfPeople) * 100) / 100;
        console.log(`üßÆ Test: ‚Ç¨${itemPrice} √∑ ${numberOfPeople} people = ‚Ç¨${splitAmount} each`);
        return splitAmount;
    };
    
    console.log('üß™ Debug function available: testSplitCalculation(8, 2) should return 4');
    
    // Add manual update function for debugging
    window.forceUpdate = function() {
        console.log('üîß Manually triggering updateItemSummary()');
        updateItemSummary();
    };
    
    window.debugCheckboxes = function(itemIndex) {
        const checkboxes = document.querySelectorAll(`input[name="item_${itemIndex}_users"]`);
        const checked = document.querySelectorAll(`input[name="item_${itemIndex}_users"]:checked`);
        console.log(`Debug item ${itemIndex}: ${checked.length}/${checkboxes.length} checkboxes checked`);
        checked.forEach((cb, i) => {
            const user = members.find(m => m.id == cb.value)?.username || 'Unknown';
            console.log(`  Checked ${i}: ${user} (id: ${cb.value})`);
        });
        return { total: checkboxes.length, checked: checked.length };
    };
    
    console.log('üß™ Additional debug functions: forceUpdate(), debugCheckboxes(itemIndex)');
});

function toggleSplitMode(itemIndex) {
    const splitCheckbox = document.querySelector(`input[name="item_${itemIndex}_split"]`);
    const dropdown = document.querySelector(`select[name="item_${itemIndex}_user"]`);
    const splitMembers = document.getElementById(`split-members-${itemIndex}`);
    const checkboxes = document.querySelectorAll(`input[name^="item_${itemIndex}_user_"]`);
    
    if (splitCheckbox && splitCheckbox.checked) {
        // Enable split mode
        if (dropdown) {
            dropdown.style.display = 'none';
            dropdown.value = ''; // Clear dropdown selection
        }
        if (splitMembers) {
            splitMembers.style.display = 'block';
        }
    } else {
        // Disable split mode
        if (dropdown) {
            dropdown.style.display = 'block';
        }
        if (splitMembers) {
            splitMembers.style.display = 'none';
        }
        // Clear all checkboxes for this item only
        checkboxes.forEach(cb => {
            if (cb) cb.checked = false;
        });
    }
    // Re-attach event listeners to checkboxes for this item
    checkboxes.forEach(cb => {
        cb.removeEventListener('change', cb._splitListener || (()=>{}));
        cb._splitListener = function() {
            try {
                const userName = members.find(m => m.id == this.value)?.username || 'Unknown';
                console.log(`üîÑ User checkbox clicked: ${this.name} = ${this.checked} (${userName} for item ${itemIndex})`);
                updateItemSummary();
            } catch (error) {
                console.error('Error in user checkbox change handler:', error);
            }
        };
        cb.addEventListener('change', cb._splitListener);
    });
    // Force immediate update
    updateItemSummary();
}

function updateItemSummary() {
    try {
        console.log('üîÑ updateItemSummary() called');
        
        const submitBtn = document.getElementById('submitBtn');
        const summaryContent = document.querySelector('.summary-content');
        const billPayerDropdown = document.getElementById('billPayer');
        
        if (!submitBtn || !summaryContent || !billPayerDropdown) {
            console.error('Missing required elements:', { submitBtn, summaryContent, billPayerDropdown });
            return;
        }
        
        let totalSelected = 0;
        let userTotals = {};
        let hasSelections = false;
        let hasBillPayer = billPayerDropdown && billPayerDropdown.value !== '';
        
        // Initialize user totals for members and guests
        members.forEach(member => {
            userTotals[member.id] = { name: member.username, amount: 0, isGuest: false };
        });
        
        guestUsers.forEach(guest => {
            userTotals[guest.id] = { name: guest.name, amount: 0, isGuest: true };
        });
        
        console.log('=== Receipt Items Calculation Debug ===');
        console.log(`Bill payer selected: ${hasBillPayer} (${billPayerDropdown.value})`);
        console.log(`Processing ${receiptItems.length} items`);
    
    // Calculate totals for each item
    receiptItems.forEach((item, index) => {
        const splitCheckbox = document.querySelector(`input[name="item_${index}_split"]`);
        const dropdown = document.querySelector(`select[name="item_${index}_user"]`);
        const allCheckboxes = document.querySelectorAll(`input[name^="item_${index}_user_"]`);
        const checkboxes = document.querySelectorAll(`input[name^="item_${index}_user_"]:checked`);
        const splitInfo = document.getElementById(`item-${index}-split`);
        
        const itemPrice = item.price || 0;
        
        console.log(`Item ${index} (${item.name}): ‚Ç¨${itemPrice}`);
        console.log(`  - Split mode: ${splitCheckbox?.checked || false}`);
        console.log(`  - Total checkboxes: ${allCheckboxes.length}`);
        console.log(`  - Checked checkboxes: ${checkboxes.length}`);
        console.log(`  - Dropdown value: ${dropdown?.value || 'none'}`);
        
        // Debug checkbox visibility and values
        allCheckboxes.forEach((cb, i) => {
            const styles = window.getComputedStyle(cb);
            console.log(`    Checkbox ${i}: name=${cb.name}, value=${cb.value}, checked=${cb.checked}, opacity=${styles.opacity}, display=${styles.display}`);
        });
        
        // Debug checked checkboxes specifically
        checkboxes.forEach((cb, i) => {
            console.log(`    CHECKED Checkbox ${i}: name=${cb.name}, value=${cb.value}, user=${members.find(m => m.id == cb.value)?.username}`);
        });
        
        let selectedUsers = [];
        let selectedNames = [];
        
        // Determine which mode we're in and process accordingly
        const isInSplitMode = splitCheckbox && splitCheckbox.checked;
        
        if (isInSplitMode) {
            // Split mode - only count explicitly selected people via checkboxes
            if (checkboxes.length > 0) {
                hasSelections = true;
                
                // Get bill payer for debt calculation
                const billPayerId = billPayerDropdown ? parseInt(billPayerDropdown.value) : null;
                const billPayerName = billPayerId ? members.find(m => m.id === billPayerId)?.username : null;
                
                // Only count people who are explicitly checked
                const numberOfPeople = checkboxes.length;
                const splitAmount = Math.round((itemPrice / numberOfPeople) * 100) / 100;
                
                // Debug logging for split calculation
                console.log(`Item ${index} (‚Ç¨${itemPrice}): Split between ${numberOfPeople} people = ‚Ç¨${splitAmount} each`);
                console.log(`  - Bill payer: ${billPayerId} (${billPayerName})`);
                console.log(`  - Selected people: ${numberOfPeople}`);
                
                const selectedNames = [];
                
                checkboxes.forEach(checkbox => {
                    const userId = parseInt(checkbox.value);
                    selectedUsers.push(userId);
                    
                    // Find user name from members or guests
                    let userName = 'Unknown';
                    const member = members.find(m => m.id === userId);
                    const guest = guestUsers.find(g => g.id === userId);
                    
                    if (member) {
                        userName = member.username;
                    } else if (guest) {
                        userName = `${guest.name} (Guest)`;
                    }
                    
                    selectedNames.push(userName);
                    
                    // Add debt for each person (including bill payer if they're selected)
                    if (userId !== billPayerId) {
                        // Other people owe money to the bill payer
                        userTotals[userId].amount += splitAmount;
                        console.log(`    ${userName} owes ‚Ç¨${splitAmount} to bill payer`);
                    } else {
                        // Bill payer selected themselves - they don't owe money to themselves
                        console.log(`    ${userName} is the bill payer - no debt to self`);
                    }
                });
                
                if (splitInfo) {
                    splitInfo.innerHTML = `
                        <span class="split-text">
                            Split between ${selectedNames.join(', ')} ‚Ä¢ ‚Ç¨${splitAmount.toFixed(2)} each
                            <small>(‚Ç¨${itemPrice.toFixed(2)} √∑ ${numberOfPeople} people)</small>
                        </span>
                    `;
                }
            } else {
                if (splitInfo) {
                    splitInfo.innerHTML = '<span class="split-text">Select people to split with</span>';
                }
            }
        } else if (dropdown && dropdown.value) {
            // Single user mode - use dropdown only (and ensure not in split mode)
            hasSelections = true;
            const userId = parseInt(dropdown.value);
            selectedUsers.push(userId);
            userTotals[userId].amount += itemPrice;
            
            // Find user name from members or guests
            let userName = 'Unknown';
            const member = members.find(m => m.id === userId);
            const guest = guestUsers.find(g => g.id === userId);
            
            if (member) {
                userName = member.username;
            } else if (guest) {
                userName = `${guest.name} (Guest)`;
            }
            
            if (splitInfo) {
                splitInfo.innerHTML = `
                    <span class="split-text">
                        ${userName} ‚Ä¢ ‚Ç¨${itemPrice.toFixed(2)}
                    </span>
                `;
            }
        } else {
            // No selection made
            if (splitInfo) {
                splitInfo.innerHTML = '<span class="split-text">Select who had this item</span>';
            }
        }
    });
    
    // Update summary
    if (hasSelections && hasBillPayer) {
        let summaryHTML = '<div class="user-totals">';
        
        Object.values(userTotals).forEach(user => {
            if (user.amount > 0) {
                // Check if this payment has been confirmed
                const isConfirmed = isPaymentConfirmed(user.name, user.amount);
                
                if (isConfirmed) {
                    // Show confirmed payment with different styling
                    summaryHTML += `
                        <div class="user-total confirmed-payment">
                            <span class="user-name">${user.name}</span>
                            <span class="user-amount confirmed">‚Ç¨${user.amount.toFixed(2)} ‚úÖ Paid</span>
                        </div>
                    `;
                } else {
                    // Show unpaid amount with payment button
                    summaryHTML += `
                        <div class="user-total">
                            <span class="user-name">${user.name}</span>
                            <span class="user-amount">‚Ç¨${user.amount.toFixed(2)}</span>
                            <button type="button" class="btn btn-small btn-qr" onclick="generatePaymentQR('${user.name}', ${user.amount.toFixed(2)})">
                                üì± Pay
                            </button>
                        </div>
                    `;
                }
            }
        });
        
        summaryHTML += '</div>';
        summaryContent.innerHTML = summaryHTML;
        submitBtn.disabled = false;
    } else {
        let message = '';
        if (!hasBillPayer && !hasSelections) {
            message = '<p>Select who paid the bill and assign items to see totals</p>';
        } else if (!hasBillPayer) {
            message = '<p>Select who paid the bill to continue</p>';
        } else if (!hasSelections) {
            message = '<p>Select items to see your total amount</p>';
        }
        summaryContent.innerHTML = message;
        submitBtn.disabled = true;
    }
    } catch (error) {
        console.error('Error in updateItemSummary:', error);
        console.error('Stack trace:', error.stack);
    }
}

function generatePaymentQR(payerName, amount) {
    const billPayerDropdown = document.getElementById('billPayer');
    const billPayerId = billPayerDropdown ? billPayerDropdown.value : null;
    
    if (!billPayerId) {
        alert('Please select who paid the bill first');
        return;
    }
    
    // Show modal with loading state
    const modal = document.getElementById('qrModal');
    const qrContent = document.getElementById('qrContent');
    
    qrContent.innerHTML = `
        <div class="qr-loading">
            <div class="loading-spinner">‚è≥</div>
            <p>Generating QR code...</p>
        </div>
    `;
    
    modal.style.display = 'flex';
    
    // Generate QR code
    const reference = `Payment from ${payerName} for receipt`;
    const url = `/api/generate_payment_qr?amount=${amount}&payer_id=${billPayerId}&reference=${encodeURIComponent(reference)}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                qrContent.innerHTML = `
                    <div class="qr-error">
                        <div class="error-icon">‚ùå</div>
                        <h4>Error</h4>
                        <p>${data.error}</p>
                        ${data.error.includes('bank details') ? 
                            '<p><small>The person who paid needs to add their bank details in settings.</small></p>' : 
                            ''
                        }
                    </div>
                `;
            } else {
                qrContent.innerHTML = `
                    <div class="qr-success">
                        <div class="qr-info">
                            <h4>Pay ‚Ç¨${amount} to ${data.recipient}</h4>
                            <p>IBAN: ${data.iban}</p>
                            <p><small>Scan with your banking app</small></p>
                        </div>
                        <div class="qr-code-container">
                            <img src="${data.qr_code}" alt="Payment QR Code" class="qr-code-image">
                        </div>
                        <div class="qr-instructions">
                            <p><strong>Instructions:</strong></p>
                            <ol>
                                <li>Open your banking app</li>
                                <li>Look for "QR Pay" or "Scan to Pay"</li>
                                <li>Scan this QR code</li>
                                <li>Confirm the payment</li>
                            </ol>
                        </div>
                        <div class="qr-actions">
                            <button type="button" class="btn btn-success btn-full" onclick="confirmPayment('${payerName}', ${amount})">
                                ‚úÖ I've Made This Payment
                            </button>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            qrContent.innerHTML = `
                <div class="qr-error">
                    <div class="error-icon">‚ùå</div>
                    <h4>Connection Error</h4>
                    <p>Could not generate QR code. Please try again.</p>
                </div>
            `;
        });
}

function closeQRModal() {
    document.getElementById('qrModal').style.display = 'none';
}

// Track confirmed payments
let confirmedPayments = new Set();

function confirmPayment(payerName, amount) {
    // Store the confirmed payment
    const paymentKey = `${payerName}_${amount}`;
    confirmedPayments.add(paymentKey);
    
    // Close the modal
    closeQRModal();
    
    // Update the UI to show payment as confirmed
    updatePaymentConfirmationUI();
    
    // Show confirmation message
    showPaymentConfirmation(payerName, amount);
}

function updatePaymentConfirmationUI() {
    // Update user totals to hide confirmed payments
    updateCalculations();
    
    // Update the hidden field with confirmed payments
    const confirmedPaymentsField = document.getElementById('confirmedPayments');
    if (confirmedPaymentsField) {
        confirmedPaymentsField.value = JSON.stringify(Array.from(confirmedPayments));
    }
}

function showPaymentConfirmation(payerName, amount) {
    // Create a temporary notification
    const notification = document.createElement('div');
    notification.className = 'payment-confirmation-toast';
    notification.innerHTML = `
        <div class="toast-content">
            <span class="toast-icon">‚úÖ</span>
            <span class="toast-message">Payment of ‚Ç¨${amount.toFixed(2)} by ${payerName} confirmed!</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

function isPaymentConfirmed(userName, amount) {
    const paymentKey = `${userName}_${amount}`;
    return confirmedPayments.has(paymentKey);
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('qrModal');
    if (event.target === modal) {
        closeQRModal();
    }
});

// Guest user management functions
function addGuestUser() {
    const guestName = prompt('Enter guest name:');
    if (!guestName || guestName.trim() === '') {
        return;
    }
    
    const guestId = guestIdCounter++;
    const guest = {
        id: guestId,
        name: guestName.trim()
    };
    
    guestUsers.push(guest);
    updateGuestUsersList();
    updateGuestUsersData();
    updateAllItemDropdowns();
    updateAllSplitSections();
    updateItemSummary();
}

function removeGuestUser(guestId) {
    guestUsers = guestUsers.filter(guest => guest.id !== guestId);
    updateGuestUsersList();
    updateGuestUsersData();
    updateAllItemDropdowns();
    updateAllSplitSections();
    updateItemSummary();
}

function updateGuestUsersList() {
    const guestUsersList = document.getElementById('guestUsersList');
    if (!guestUsersList) return;
    
    if (guestUsers.length === 0) {
        guestUsersList.innerHTML = '';
        return;
    }
    
    let guestHTML = '';
    guestUsers.forEach(guest => {
        guestHTML += `
            <div class="member-checkbox guest-checkbox">
                <span class="guest-info">${guest.name} (Guest)</span>
                <button type="button" class="btn btn-small btn-danger guest-remove" onclick="removeGuestUser(${guest.id})">√ó</button>
            </div>
        `;
    });
    
    guestUsersList.innerHTML = guestHTML;
}

function updateGuestUsersData() {
    const guestUsersField = document.getElementById('guestUsers');
    if (guestUsersField) {
        guestUsersField.value = JSON.stringify(guestUsers);
    }
}

function updateAllItemDropdowns() {
    // Update all item selection dropdowns to include guests
    receiptItems.forEach((item, index) => {
        const dropdown = document.querySelector(`select[name="item_${index}_user"]`);
        if (dropdown) {
            const currentValue = dropdown.value;
            
            // Clear current options except the first one
            while (dropdown.children.length > 1) {
                dropdown.removeChild(dropdown.lastChild);
            }
            
            // Add member options
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.username;
                dropdown.appendChild(option);
            });
            
            // Add guest options
            guestUsers.forEach(guest => {
                const option = document.createElement('option');
                option.value = guest.id;
                option.textContent = `${guest.name} (Guest)`;
                dropdown.appendChild(option);
            });
            
            // Restore previous selection if it still exists
            if (currentValue) {
                dropdown.value = currentValue;
            }
        }
    });
}

function updateAllSplitSections() {
    // Update all split sections to include guests
    receiptItems.forEach((item, index) => {
        const splitMembers = document.getElementById(`split-members-${index}`);
        if (splitMembers) {
            const splitCheckboxes = splitMembers.querySelector('.split-checkboxes');
            if (splitCheckboxes) {
                // Clear existing guest checkboxes
                const existingGuestCheckboxes = splitCheckboxes.querySelectorAll('label[data-guest-id]');
                existingGuestCheckboxes.forEach(checkbox => checkbox.remove());
                
                // Add guest checkboxes
                guestUsers.forEach(guest => {
                    const label = document.createElement('label');
                    label.className = 'member-checkbox';
                    label.setAttribute('data-guest-id', guest.id);
                    
                    label.innerHTML = `
                        <input type="checkbox" 
                               name="item_${index}_user_${guest.id}" 
                               id="item_${index}_user_${guest.id}" 
                               value="${guest.id}">
                        <span class="checkbox-custom"></span>
                        <span class="member-name">${guest.name} (Guest)</span>
                    `;
                    
                    // Add event listener
                    const checkbox = label.querySelector('input');
                    checkbox.addEventListener('change', function() {
                        try {
                            console.log(`üîÑ Guest checkbox clicked: ${this.name} = ${this.checked} (${guest.name} for item ${index})`);
                            updateItemSummary();
                        } catch (error) {
                            console.error('Error in guest checkbox change handler:', error);
                        }
                    });
                    
                    splitCheckboxes.appendChild(label);
                });
            }
        }
    });
}
</script>
{% endblock %} 