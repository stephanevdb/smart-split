{% extends "base.html" %}

{% block title %}Select Items - {{ group.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="form-container">
        <div class="form-header">
            <h2>üçΩÔ∏è Select Your Items</h2>
            <p>From <strong>{{ receipt_analysis['store_name'] or "Receipt" }}</strong> ‚Ä¢ Total: ‚Ç¨{{ "%.2f"|format(receipt_analysis['total_amount']) }}</p>
        </div>
        
        <form method="POST" id="itemSelectionForm">
            <input type="hidden" id="confirmedPayments" name="confirmed_payments" value="">
            <input type="hidden" id="guestUsers" name="guest_users" value="">
            <div class="receipt-items-container">
                <div class="receipt-summary">
                    <h3>üìã Receipt Items</h3>
                    <p>Select which group members consumed each item.</p>
                </div>
                
                <div class="payer-selection">
                    <h4>üí≥ Who paid this bill?</h4>
                    <select name="bill_payer" id="billPayer" class="user-dropdown" required>
                        <option value="">Select who paid the bill...</option>
                        {% for member in members %}
                            <option value="{{ member['id'] }}" {% if member['id'] == current_user.id %}selected{% endif %}>
                                {{ member['username'] }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Guest Users Section -->
                <div class="guest-users-section">
                    <div class="guest-header">
                        <h4>üë• Add Guest Users</h4>
                        <p class="guest-description">Add temporary guests for this receipt only</p>
                        <button type="button" class="btn btn-small btn-secondary" onclick="addGuestUser()">+ Add Guest</button>
                    </div>
                    <div class="guest-users-list" id="guestUsersList">
                        <!-- Guest users will be added here dynamically -->
                    </div>
                </div>
                
                <div class="items-list">
                    {% for item in receipt_analysis['items'] %}
                        <div class="item-card">
                            <div class="item-info">
                                <div class="item-name">{{ item.name }}</div>
                                <div class="item-price">‚Ç¨{{ "%.2f"|format(item.price) }}</div>
                            </div>
                            
                            <div class="item-selection">
                                <select name="item_{{ loop.index0 }}_user" class="user-dropdown">
                                    <option value="">Select who had this item...</option>
                                    {% for member in members %}
                                        <option value="{{ member['id'] }}">{{ member['username'] }}</option>
                                    {% endfor %}
                                </select>
                                
                                <div class="item-info-display" id="item-{{ loop.index0 }}-info">
                                    <span class="item-text">Select who had this item</span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="selection-summary" id="selectionSummary">
                    <h3>üí∞ Your Total</h3>
                    <div class="summary-content">
                        <p>Select items to see your total amount</p>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                        <span class="btn-icon">‚úÖ</span>
                        Add Selected Items
                    </button>
                    <a href="{{ url_for('scan_receipt', group_id=group.id) }}" class="btn btn-secondary">
                        Back to Upload
                    </a>
                    <a href="{{ url_for('add_expense', group_id=group.id) }}" class="btn btn-secondary">
                        Manual Entry Instead
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal" id="qrModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üí≥ Payment QR Code</h3>
            <button class="modal-close" onclick="closeQRModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="qrContent">
                <div class="qr-loading">
                    <div class="loading-spinner">‚è≥</div>
                    <p>Generating QR code...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="application/json" id="receipt-items-data">{{ receipt_analysis['items']|tojson }}</script>
<script type="application/json" id="members-data">{{ members|tojson }}</script>
<script>
let receiptItems = [];
let members = [];
let guestUsers = [];
let guestIdCounter = 1000; // Start with high number to avoid conflicts with member IDs
let guestTotals = {}; // Separate tracking for guest EPC amounts

document.addEventListener('DOMContentLoaded', function() {
    receiptItems = JSON.parse(document.getElementById('receipt-items-data').textContent);
    members = JSON.parse(document.getElementById('members-data').textContent);
    
    console.log('=== Receipt Items Page Initialized ===');
    console.log('Receipt items:', receiptItems.length);
    console.log('Members:', members.length);
    
    console.log('=== Receipt Items Page Initialized ===');
    console.log('Split functionality removed - using dropdown selection only');
    
    // Add event listeners to all user dropdowns for real-time updates
    document.querySelectorAll('select[name*="_user"]').forEach(dropdown => {
        dropdown.addEventListener('change', function() {
            updateItemSummary();
        });
    });
    
    // Add event listener to bill payer dropdown
    const billPayerDropdown = document.getElementById('billPayer');
    if (billPayerDropdown) {
        billPayerDropdown.addEventListener('change', function() {
            updateItemSummary();
        });
    }
    
    updateItemSummary();
});

function updateItemSummary() {
    try {
        console.log('üîÑ updateItemSummary() called');
        
        const submitBtn = document.getElementById('submitBtn');
        const summaryContent = document.querySelector('.summary-content');
        const billPayerDropdown = document.getElementById('billPayer');
        
        if (!submitBtn || !summaryContent || !billPayerDropdown) {
            console.error('Missing required elements:', { submitBtn, summaryContent, billPayerDropdown });
            return;
        }
        
        let totalSelected = 0;
        let userTotals = {};
        let hasSelections = false;
        let hasBillPayer = billPayerDropdown && billPayerDropdown.value !== '';
        
        // Initialize user totals for members only (guests tracked separately)
        members.forEach(member => {
            userTotals[member.id] = { name: member.username, amount: 0, isGuest: false };
        });
        
        // Initialize separate guest totals for EPC codes only
        guestTotals = {};
        guestUsers.forEach(guest => {
            guestTotals[guest.id] = { name: guest.name, amount: 0 };
        });
        
        console.log('=== Receipt Items Calculation Debug ===');
        console.log(`Bill payer selected: ${hasBillPayer} (${billPayerDropdown.value})`);
        console.log(`Processing ${receiptItems.length} items`);
    
    // Calculate totals for each item (dropdown selection only)
    receiptItems.forEach((item, index) => {
        const dropdown = document.querySelector(`select[name="item_${index}_user"]`);
        const itemInfo = document.getElementById(`item-${index}-info`);
        const itemPrice = item.price || 0;
        
        console.log(`Item ${index} (${item.name}): ‚Ç¨${itemPrice}`);
        console.log(`  - Dropdown value: ${dropdown?.value || 'none'}`);
        
        if (dropdown && dropdown.value) {
            // User selected for this item
            hasSelections = true;
            const userId = parseInt(dropdown.value);
            
            // Find user name from members or guests
            let userName = 'Unknown';
            const member = members.find(m => m.id === userId);
            const guest = guestUsers.find(g => g.id === userId);
            
            if (member) {
                userName = member.username;
                // Members: add to group debt tracking (ignore if they're the bill payer)
                const billPayerId = billPayerDropdown ? parseInt(billPayerDropdown.value) : null;
                if (userId !== billPayerId) {
                    userTotals[userId].amount += itemPrice;
                    console.log(`    ${userName} owes ‚Ç¨${itemPrice} to group (debt tracking)`);
                } else {
                    console.log(`    ${userName} is the bill payer - no debt to self`);
                }
            } else if (guest) {
                userName = `${guest.name} (Guest)`;
                // Guests: add to separate totals for EPC code only (no group debt)
                guestTotals[userId].amount += itemPrice;
                console.log(`    ${userName} gets ‚Ç¨${itemPrice} for EPC code only (isolated from group)`);
            }
            
            if (itemInfo) {
                itemInfo.innerHTML = `
                    <span class="item-text">
                        ${userName} ‚Ä¢ ‚Ç¨${itemPrice.toFixed(2)}
                    </span>
                `;
            }
        } else {
            // No selection made
            if (itemInfo) {
                itemInfo.innerHTML = '<span class="item-text">Select who had this item</span>';
            }
        }
    });
    
    // Update summary
    if (hasSelections && hasBillPayer) {
        let summaryHTML = '<div class="user-totals">';
        
        // Show group member debts only (these affect the group)
        Object.values(userTotals).forEach(user => {
            if (user.amount > 0) {
                const isConfirmed = isPaymentConfirmed(user.name, user.amount);
                
                if (isConfirmed) {
                    summaryHTML += `
                        <div class="user-total confirmed-payment">
                            <span class="user-name">${user.name}</span>
                            <span class="user-amount confirmed">‚Ç¨${user.amount.toFixed(2)} ‚úÖ Paid</span>
                        </div>
                    `;
                } else {
                    summaryHTML += `
                        <div class="user-total">
                            <span class="user-name">${user.name}</span>
                            <span class="user-amount">‚Ç¨${user.amount.toFixed(2)}</span>
                            <button type="button" class="btn btn-small btn-qr" onclick="generatePaymentQR('${user.name}', ${user.amount.toFixed(2)})">
                                üì± Pay
                            </button>
                        </div>
                    `;
                }
            }
        });
        
        // Show guest payments separately (isolated from group calculations)
        const guestValues = Object.values(guestTotals).filter(guest => guest.amount > 0);
        if (guestValues.length > 0) {
            summaryHTML += '<div class="guest-payments-section">';
            summaryHTML += '<h4 class="guest-payments-title">Guest Payments (EPC Only)</h4>';
            
            guestValues.forEach(guest => {
                const isConfirmed = isPaymentConfirmed(guest.name, guest.amount);
                
                if (isConfirmed) {
                    summaryHTML += `
                        <div class="user-total guest-total confirmed-payment">
                            <span class="user-name">${guest.name}</span>
                            <span class="user-amount confirmed">‚Ç¨${guest.amount.toFixed(2)} ‚úÖ Paid</span>
                        </div>
                    `;
                } else {
                    summaryHTML += `
                        <div class="user-total guest-total">
                            <span class="user-name">${guest.name}</span>
                            <span class="user-amount">‚Ç¨${guest.amount.toFixed(2)}</span>
                            <button type="button" class="btn btn-small btn-qr" onclick="generatePaymentQR('${guest.name}', ${guest.amount.toFixed(2)})">
                                üì± Pay
                            </button>
                        </div>
                    `;
                }
            });
            
            summaryHTML += '</div>';
        }
        
        summaryHTML += '</div>';
        summaryContent.innerHTML = summaryHTML;
        submitBtn.disabled = false;
    } else {
        let message = '';
        if (!hasBillPayer && !hasSelections) {
            message = '<p>Select who paid the bill and assign items to see totals</p>';
        } else if (!hasBillPayer) {
            message = '<p>Select who paid the bill to continue</p>';
        } else if (!hasSelections) {
            message = '<p>Select items to see your total amount</p>';
        }
        summaryContent.innerHTML = message;
        submitBtn.disabled = true;
    }
    } catch (error) {
        console.error('Error in updateItemSummary:', error);
        console.error('Stack trace:', error.stack);
    }
}

function generatePaymentQR(payerName, amount) {
    const billPayerDropdown = document.getElementById('billPayer');
    const billPayerId = billPayerDropdown ? billPayerDropdown.value : null;
    
    if (!billPayerId) {
        alert('Please select who paid the bill first');
        return;
    }
    
    // Show modal with loading state
    const modal = document.getElementById('qrModal');
    const qrContent = document.getElementById('qrContent');
    
    qrContent.innerHTML = `
        <div class="qr-loading">
            <div class="loading-spinner">‚è≥</div>
            <p>Generating QR code...</p>
        </div>
    `;
    
    modal.style.display = 'flex';
    
    // Generate QR code
    const reference = `Payment from ${payerName} for receipt`;
    const url = `/api/generate_payment_qr?amount=${amount}&payer_id=${billPayerId}&reference=${encodeURIComponent(reference)}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                qrContent.innerHTML = `
                    <div class="qr-error">
                        <div class="error-icon">‚ùå</div>
                        <h4>Error</h4>
                        <p>${data.error}</p>
                        ${data.error.includes('bank details') ? 
                            '<p><small>The person who paid needs to add their bank details in settings.</small></p>' : 
                            ''
                        }
                    </div>
                `;
            } else {
                qrContent.innerHTML = `
                    <div class="qr-success">
                        <div class="qr-info">
                            <h4>Pay ‚Ç¨${amount} to ${data.recipient}</h4>
                            <p>IBAN: ${data.iban}</p>
                            <p><small>Scan with your banking app</small></p>
                        </div>
                        <div class="qr-code-container">
                            <img src="${data.qr_code}" alt="Payment QR Code" class="qr-code-image">
                        </div>
                        <div class="qr-instructions">
                            <p><strong>Instructions:</strong></p>
                            <ol>
                                <li>Open your banking app</li>
                                <li>Look for "QR Pay" or "Scan to Pay"</li>
                                <li>Scan this QR code</li>
                                <li>Confirm the payment</li>
                            </ol>
                        </div>
                        <div class="qr-actions">
                            <button type="button" class="btn btn-success btn-full" onclick="confirmPayment('${payerName}', ${amount})">
                                ‚úÖ I've Made This Payment
                            </button>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            qrContent.innerHTML = `
                <div class="qr-error">
                    <div class="error-icon">‚ùå</div>
                    <h4>Connection Error</h4>
                    <p>Could not generate QR code. Please try again.</p>
                </div>
            `;
        });
}

function closeQRModal() {
    document.getElementById('qrModal').style.display = 'none';
}

// Track confirmed payments
let confirmedPayments = new Set();

function confirmPayment(payerName, amount) {
    // Store the confirmed payment
    const paymentKey = `${payerName}_${amount}`;
    confirmedPayments.add(paymentKey);
    
    // Close the modal
    closeQRModal();
    
    // Update the UI to show payment as confirmed
    updatePaymentConfirmationUI();
    
    // Show confirmation message
    showPaymentConfirmation(payerName, amount);
}

function updatePaymentConfirmationUI() {
    // Update user totals to hide confirmed payments
    updateCalculations();
    
    // Update the hidden field with confirmed payments
    const confirmedPaymentsField = document.getElementById('confirmedPayments');
    if (confirmedPaymentsField) {
        confirmedPaymentsField.value = JSON.stringify(Array.from(confirmedPayments));
    }
}

function showPaymentConfirmation(payerName, amount) {
    // Create a temporary notification
    const notification = document.createElement('div');
    notification.className = 'payment-confirmation-toast';
    notification.innerHTML = `
        <div class="toast-content">
            <span class="toast-icon">‚úÖ</span>
            <span class="toast-message">Payment of ‚Ç¨${amount.toFixed(2)} by ${payerName} confirmed!</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

function isPaymentConfirmed(userName, amount) {
    const paymentKey = `${userName}_${amount}`;
    return confirmedPayments.has(paymentKey);
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('qrModal');
    if (event.target === modal) {
        closeQRModal();
    }
});

// Guest user management functions
function addGuestUser() {
    const guestName = prompt('Enter guest name:');
    if (!guestName || guestName.trim() === '') {
        return;
    }
    
    const guestId = guestIdCounter++;
    const guest = {
        id: guestId,
        name: guestName.trim()
    };
    
    guestUsers.push(guest);
    updateGuestUsersList();
    updateGuestUsersData();
    updateAllItemDropdowns();
    updateItemSummary();
}

function removeGuestUser(guestId) {
    guestUsers = guestUsers.filter(guest => guest.id !== guestId);
    updateGuestUsersList();
    updateGuestUsersData();
    updateAllItemDropdowns();
    updateItemSummary();
}

function updateGuestUsersList() {
    const guestUsersList = document.getElementById('guestUsersList');
    if (!guestUsersList) return;
    
    if (guestUsers.length === 0) {
        guestUsersList.innerHTML = '';
        return;
    }
    
    let guestHTML = '';
    guestUsers.forEach(guest => {
        guestHTML += `
            <div class="guest-pill">
                <span class="guest-name">${guest.name}</span>
                <button type="button" class="guest-remove" onclick="removeGuestUser(${guest.id})">√ó</button>
            </div>
        `;
    });
    
    guestUsersList.innerHTML = guestHTML;
}

function updateGuestUsersData() {
    const guestUsersField = document.getElementById('guestUsers');
    if (guestUsersField) {
        guestUsersField.value = JSON.stringify(guestUsers);
    }
}

function updateAllItemDropdowns() {
    // Update all item selection dropdowns to include guests
    receiptItems.forEach((item, index) => {
        const dropdown = document.querySelector(`select[name="item_${index}_user"]`);
        if (dropdown) {
            const currentValue = dropdown.value;
            
            // Clear current options except the first one
            while (dropdown.children.length > 1) {
                dropdown.removeChild(dropdown.lastChild);
            }
            
            // Add member options
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.username;
                dropdown.appendChild(option);
            });
            
            // Add guest options
            guestUsers.forEach(guest => {
                const option = document.createElement('option');
                option.value = guest.id;
                option.textContent = `${guest.name} (Guest)`;
                dropdown.appendChild(option);
            });
            
            // Restore previous selection if it still exists
            if (currentValue) {
                dropdown.value = currentValue;
            }
        }
    });
}


</script>
{% endblock %} 